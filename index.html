<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leg Raise Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        canvas { position: absolute; left: 0; top: 0; z-index: 1; }
        video { transform: scaleX(-1); display: none; margin: auto; }
    </style>
</head>
<body>
    <h1>Leg Raise Detection</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <p id="classification"></p>
    <audio id="warning-audio" src="leg_raises.mp3"></audio>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const classificationText = document.getElementById('classification');
        const warningAudio = document.getElementById('warning-audio');

        async function setupCamera() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            return new Promise((resolve) => {
                videoElement.onloadedmetadata = () => resolve(videoElement);
            });
        }

        function calculateAngle(a, b, c) {
            const ba = [a.x - b.x, a.y - b.y];
            const bc = [c.x - b.x, c.y - b.y];
            const cosineAngle = (ba[0] * bc[0] + ba[1] * bc[1]) /
                                (Math.sqrt(ba[0] ** 2 + ba[1] ** 2) * Math.sqrt(bc[0] ** 2 + bc[1] ** 2));
            return Math.acos(Math.max(-1, Math.min(1, cosineAngle))) * (180 / Math.PI);
        }

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                const landmarks = results.poseLandmarks;
                const leftHip = landmarks[23]; 
                const leftKnee = landmarks[25];
                const leftAnkle = landmarks[27];

                const kneeAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
                let classification = "";

                if (kneeAngle >= 175) {
                    classification = "Correct";
                } else if (kneeAngle >= 150) {
                    classification = "Almost Correct";
                } else {
                    classification = "Incorrect";
                    if (warningAudio.paused) warningAudio.play();
                }

                classificationText.innerText = `Left Knee Angle: ${kneeAngle.toFixed(2)}Â° - ${classification}`;
            }
        }

        async function main() {
            await setupCamera();
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            pose.onResults(onResults);

            async function detect() {
                await pose.send({ image: videoElement });
                requestAnimationFrame(detect);
            }

            detect();
        }

        main();
    </script>
</body>
</html>
